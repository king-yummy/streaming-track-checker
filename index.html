<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PLLI ìŠ¤ë°ì²´í¬</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
    <link rel="apple-touch-icon" href="icon-512.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Jua&display=swap"
      rel="stylesheet"
    />
    <meta name="theme-color" content="#dbeafe" />
    <meta name="google-adsense-account" content="ca-pub-9063401338616510" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
    />
    <script>
      window.tailwindConfig = {
        theme: {
          fontFamily: {
            sans: ["Pretendard", "ui-sans-serif", "system-ui"],
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      @keyframes bgShift {
        0%,
        100% {
          background-color: #dbeafe;
        }
        50% {
          background-color: #bfdbfe;
        }
      }
      .playing {
        animation: bgShift 2.5s ease-in-out infinite;
      }
      html,
      body {
        background-color: white;
      }
    </style>
  </head>
  <body
    class="font-sans bg-gray-100 min-h-screen flex flex-col items-center p-4"
  >
    <div
      id="loading-screen"
      class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center"
    >
      <img
        src="icon-192.png"
        alt="ìŠ¤ë°ì²´í¬ ë¡œê³ "
        class="w-16 h-16 mb-4 animate-bounce"
      />
      <p class="text-gray-700 font-medium text-lg">ì ê¹ ê¸°ë‹¤ë¦¬ë©´ ë³´ì—¬ì£¼ê² ì§€~</p>
    </div>

    <!-- í—¤ë” -->
    <header class="w-full max-w-md mt-2 mb-2 text-center">
      <h1
        class="text-3xl tracking-wide"
        style="font-family: 'Jua', sans-serif; font-weight: 400"
      >
        <span class="font-bold">ã€Œã‹ãã‚Œã‚“ã¼ã€</span> ìŠ¤íŠ¸ë¦¬ë° ë¦¬ìŠ¤íŠ¸
      </h1>
      <div
        class="flex justify-between items-center mt-2 text-sm text-gray-700 px-1"
      >
        <div class="flex items-center gap-2">
          <span>ì •ê° ì•Œë¦¼</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="alarm-toggle" class="sr-only peer" />
            <div
              class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-blue-500 transition-all"
            ></div>
            <div
              class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-full transition-all"
            ></div>
          </label>
        </div>
        <span class="text-xs text-gray-500">25.06.16 ver.</span>
      </div>
    </header>

    <main class="w-full max-w-md space-y-2 overflow-auto">
      <ul id="playlist" class="space-y-2"></ul>
    </main>

    <section
      id="dashboard"
      class="w-full max-w-md mt-4 mb-2 p-4 bg-white rounded-2xl shadow flex flex-col items-center space-y-3"
    >
      <h2 class="text-sm text-gray-600 font-semibold">
        16ì¼ ìì •ë¶€í„° ìŠ¤ë°ì´ ëŠê¸°ì§€ ì•Šì•˜ë‹¤ë©´!
      </h2>
      <div class="grid grid-cols-3 gap-4 w-full text-center">
        <div>
          <p class="text-[11px] text-gray-500 mb-1">ã‹ãã‚Œã‚“ã¼</p>
          <p class="text-2xl font-bold">
            <span id="count-kakurenbo">0</span>íšŒ
          </p>
        </div>
        <div>
          <p class="text-[11px] text-gray-500 mb-1">Rizz - JP</p>
          <p class="text-2xl font-bold"><span id="count-rizz">0</span>íšŒ</p>
        </div>
        <div>
          <p class="text-[11px] text-gray-500 mb-1">Chroma Drift - JP</p>
          <p class="text-2xl font-bold"><span id="count-chroma">0</span>íšŒ</p>
        </div>
      </div>
    </section>

    <footer
      class="w-full max-w-md text-center text-xs text-gray-500 mt-2 mb-4 space-y-2"
    >
      <p>í”Œë ˆì´ë¸Œ ìŒì›ì´ê³µíŒ€ì˜ ìŠ¤íŠ¸ë¦¬ë° ë¦¬ìŠ¤íŠ¸ì— ë”°ë¼ ìš´ì˜ë˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.</p>
      <p>
        ë¬¸ì˜ ë° ê±´ì˜ì‚¬í•­ì€ X(íŠ¸ìœ„í„°)
        <strong
          ><a
            href="https://x.com/plave_pretty?s=21&t=KweQO4B2QEKZ954vZ1zJ5"
            target="_blank"
            rel="noopener"
            class="text-blue-600 hover:underline"
            >@plave_pretty</a
          ></strong
        >
        ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.
      </p>
      <p class="text-[10px] text-gray-400 mt-2">
        ì´ í˜ì´ì§€ëŠ” í”Œë ˆì´ë¸Œ íŒ¬ë¤ <strong>PLLI</strong>ë§Œì„ ìœ„í•´
        ì œì‘í•˜ì˜€ìŠµë‹ˆë‹¤.<br />
        íƒ€ íŒ¬ë¤ì—ì„œì˜ ë¬´ë‹¨ ë³µì œÂ·ì¬ê°€ê³µÂ·ì‚¬ìš© ë°œê²¬ ì‹œ ë¹ ë¥´ê²Œ ëŒ€ì‘í•©ë‹ˆë‹¤. ğŸ•µï¸â€â™€ï¸
      </p>
    </footer>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      const SHEET_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vR7sUDMYoUsBpvEC9LjO25CnstexV74iKXfwRWVdqpQCOm65rzvJ6RrnedOv6JSqEYJNqyr2cje75CJ/pub?gid=0&single=true&output=csv";

      const START_AT_MS = new Date("2025-06-16T00:00:00+09:00").getTime();

      const TARGETS = {
        kakurenbo: "ã‹ãã‚Œã‚“ã¼",
        rizz: "Rizz - japanese Ver.",
        chroma: "Chroma Drift - japanese Ver.",
      };

      const PER_CYCLE = {
        kakurenbo: 4,
        rizz: 3,
        chroma: 1,
      };

      let schedule = [];

      const toSec = (mmss) => {
        const [m, s] = mmss.split(":").map(Number);
        return m * 60 + s;
      };

      const formatKoreanTime = (str) => {
        const [m, s] = str.split(":").map(Number);
        return `${m}ë¶„ ${s.toString().padStart(2, "0")}ì´ˆ`;
      };

      const formatTimeMMSS = (sec) => {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, "0")}`;
      };

      async function loadSchedule() {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const rows = text.trim().split("\n").slice(1);

        schedule = rows.map((line) => {
          const [title, start, end, cover] = line
            .split(",")
            .map((s) => s.trim());
          return {
            title,
            start,
            end,
            cover,
            startSec: toSec(start),
            endSec: toSec(end),
          };
        });

        renderPlaylist();
        tick();
        setInterval(tick, 1000);

        document.getElementById("loading-screen").style.display = "none";
      }

      function renderPlaylist() {
        const ul = document.getElementById("playlist");
        ul.innerHTML = schedule
          .map(
            (item, i) => `
      <li data-index="${i}" class="flex flex-col p-2 rounded-lg shadow w-full opacity-50 transition-all bg-white text-[13px]">
        <div class="flex items-center gap-2">
          <div class="w-10 h-10 flex-shrink-0 bg-gray-200 rounded overflow-hidden">
            <img src="${item.cover}" alt="${
              item.title
            }" class="w-full h-full object-cover" />
          </div>
          <div class="flex-1">
            <p class="font-medium truncate">${i + 1}. ${item.title}</p>
            <p class="text-xs text-gray-500">${formatKoreanTime(
              item.start
            )} ~ ${formatKoreanTime(item.end)}</p>
          </div>
        </div>
        <div class="flex items-center gap-1 text-[11px] px-1 mt-1">
          <span id="start-${i}" class="w-[40px] text-left text-gray-400">+0:00</span>
          <div class="flex-1 h-1 bg-gray-200 rounded overflow-hidden">
            <div id="p-${i}" class="h-full bg-blue-400 transition-all" style="width:0%"></div>
          </div>
          <span id="end-${i}" class="w-[40px] text-right text-gray-400">-0:00</span>
        </div>
      </li>`
          )
          .join("");
      }

      function tick() {
        const now = new Date();
        const diffSec = Math.max(
          0,
          Math.floor((Date.now() - START_AT_MS) / 1000)
        );
        const cycles = Math.floor(diffSec / 3600);
        const secInLoop = diffSec % 3600;

        updateHighlight(secInLoop);
        updateCounts(cycles, secInLoop);
        updateProgress(secInLoop);
      }

      function updateHighlight(secInLoop) {
        const idx = schedule.findIndex(
          (item) => secInLoop >= item.startSec && secInLoop < item.endSec
        );

        document.querySelectorAll("#playlist li").forEach((li) => {
          const i = Number(li.dataset.index);
          const startEl = document.getElementById(`start-${i}`);
          const endEl = document.getElementById(`end-${i}`);

          if (i === idx) {
            li.classList.remove("opacity-50");
            li.classList.add("opacity-100", "playing");
            startEl.classList.remove("text-gray-400");
            endEl.classList.remove("text-gray-400");
            startEl.classList.add("text-blue-600");
            endEl.classList.add("text-blue-600");
          } else {
            li.classList.add("opacity-50");
            li.classList.remove("opacity-100", "playing");
            startEl.classList.add("text-gray-400");
            endEl.classList.add("text-gray-400");
            startEl.classList.remove("text-blue-600");
            endEl.classList.remove("text-blue-600");
          }
        });
      }

      function updateProgress(secInLoop) {
        schedule.forEach((item, i) => {
          const bar = document.getElementById(`p-${i}`);
          const startEl = document.getElementById(`start-${i}`);
          const endEl = document.getElementById(`end-${i}`);

          if (!bar || !startEl || !endEl) return;

          const total = item.endSec - item.startSec;
          const passed = secInLoop - item.startSec;
          const remain = item.endSec - secInLoop;

          if (secInLoop >= item.startSec && secInLoop < item.endSec) {
            const pct = (passed / total) * 100;
            bar.style.width = `${pct}%`;
            startEl.textContent = `+${formatTimeMMSS(passed)}`;
            endEl.textContent = `-${formatTimeMMSS(remain)}`;
          } else {
            bar.style.width = "0%";
            startEl.textContent = `+0:00`;
            endEl.textContent = `-0:00`;
          }
        });
      }

      function updateCounts(cycles, secInLoop) {
        const counts = {
          kakurenbo: cycles * PER_CYCLE.kakurenbo,
          rizz: cycles * PER_CYCLE.rizz,
          chroma: cycles * PER_CYCLE.chroma,
        };

        schedule.forEach((item) => {
          if (item.startSec <= secInLoop) {
            if (item.title === TARGETS.kakurenbo) counts.kakurenbo += 1;
            else if (item.title === TARGETS.rizz) counts.rizz += 1;
            else if (item.title === TARGETS.chroma) counts.chroma += 1;
          }
        });

        document.getElementById("count-kakurenbo").textContent =
          counts.kakurenbo;
        document.getElementById("count-rizz").textContent = counts.rizz;
        document.getElementById("count-chroma").textContent = counts.chroma;
      }

      loadSchedule();
    </script>

    <style>
      html,
      body {
        background-color: white;
      }
    </style>

    <!-- Firebase ëª¨ë“ˆ ê¸°ë°˜ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
      // âœ… [ìˆ˜ì •] import êµ¬ë¬¸ì€ ìŠ¤í¬ë¦½íŠ¸ì˜ ê°€ì¥ ìµœìƒë‹¨ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getMessaging,
        getToken,
        onMessage,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

      // ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•œ ê¹ƒë°œ(í”Œë˜ê·¸)
      if (window.firebaseHasBeenInitialized) {
        // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆë‹¤ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
      } else {
        // ì²˜ìŒ ì‹¤í–‰ë˜ëŠ” ê²½ìš°, ê¹ƒë°œì„ ì„¸ì›ë‹ˆë‹¤.
        window.firebaseHasBeenInitialized = true;

        // âœ… [ìˆ˜ì •] importë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ëª¨ë“  ë¡œì§ì€ ì´ else ë¸”ë¡ ì•ˆì— ìœ„ì¹˜í•©ë‹ˆë‹¤.
        const firebaseConfig = {
          apiKey: "AIzaSyDam42H9W_iouj0rkMZDDzSWsrmx8BlVkQ",
          authDomain: "plli-checker.firebaseapp.com",
          projectId: "plli-checker",
          storageBucket: "plli-checker.firebasestorage.app",
          messagingSenderId: "517953309352",
          appId: "1:517953309352:web:a5c5a3919ff5bd8822d09d",
          measurementId: "G-GYGLSJRN79",
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const messaging = getMessaging(app);

        let currentToken = null;
        let lastSentToken = null;
        let lastSentOptIn = null;

        function saveFCMTokenToServer(token, alarmOptIn) {
          if (token === lastSentToken && alarmOptIn === lastSentOptIn) {
            return;
          }
          lastSentToken = token;
          lastSentOptIn = alarmOptIn;
          fetch("http://localhost:3001/api/save-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, alarmOptIn }),
          }).then((res) => console.log("ì„œë²„ ì‘ë‹µ ìƒíƒœ:", res.status));
        }

        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("/firebase-messaging-sw.js")
            .then((registration) => navigator.serviceWorker.ready)
            .then((readyRegistration) => {
              console.log("âœ… ì„œë¹„ìŠ¤ ì›Œì»¤ ì¤€ë¹„ ì™„ë£Œ!");
              // âœ… [ìˆ˜ì •] ì¤€ë¹„ëœ ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì •ë³´ë¥¼ í•¨ìˆ˜ì— ì¸ìë¡œ ì „ë‹¬
              requestPermissionAndToken(readyRegistration);
            })
            .catch((error) =>
              console.error("âŒ ì„œë¹„ìŠ¤ ì›Œì»¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error)
            );
        }

        // âœ… [ìˆ˜ì •] í•¨ìˆ˜ê°€ registration ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ë„ë¡ ë³€ê²½
        function requestPermissionAndToken(registration) {
          Notification.requestPermission().then((permission) => {
            if (permission !== "granted") {
              console.warn("ğŸ”• ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              return;
            }
            console.log("ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨. í† í° ìš”ì²­ ì¤‘...");
            // âœ… [ìˆ˜ì •] getTokenì— serviceWorkerRegistrationì„ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬
            getToken(messaging, {
              vapidKey:
                "BHKOgIoE52ImNaT3yKv_w1yJVSPL2WfUZHCp2VKUF0DvWiOVi2cNFQ-qS2XzjRt2HliwcK-U-BFrDXbxBfpI7MA",
              serviceWorkerRegistration: registration,
            })
              .then((token) => {
                if (!token) {
                  console.log("í† í° ë°œê¸‰ ë¶ˆê°€. ì„¤ì • í™•ì¸ í•„ìš”.");
                  return;
                }
                currentToken = token;
                const alarmOptIn =
                  localStorage.getItem("alarmOptIn") === "true";
                saveFCMTokenToServer(token, alarmOptIn);
                console.log("ğŸ“² FCM Token:", token);
              })
              .catch((err) => console.error("âŒ í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", err));
          });
        }

        onMessage(messaging, (payload) => {
          console.log("ğŸ“¥ í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€:", payload);
          alert(payload.notification?.title || "ì•Œë¦¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤");
        });

        const toggle = document.getElementById("alarm-toggle");
        if (toggle) {
          toggle.checked = localStorage.getItem("alarmOptIn") === "true";
          toggle.addEventListener("change", (e) => {
            const isOn = e.target.checked;
            localStorage.setItem("alarmOptIn", isOn ? "true" : "false");
            if (currentToken) {
              saveFCMTokenToServer(currentToken, isOn);
            }
          });
        }
      }
    </script>
  </body>
</html>
